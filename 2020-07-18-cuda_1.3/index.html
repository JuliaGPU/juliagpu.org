<!doctype html>

<html lang="en" class="h-100">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta content="index, follow" name="robots">
  <meta name="generator" content="Hugo 0.77.0" />
  <link rel="stylesheet" href="https://juliagpu.org/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="/highlight.css">
  <script src="/highlight.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <style>
    .hljs {
      padding: 0;
      background: none;
  }
  </style>

  
  
  
  <title>CUDA.jl 1.3 - Multi-device programming Â· JuliaGPU</title>
  <style>
.container {
  max-width: 700px;
}
#nav-border {
  border-bottom: 1px solid #212529;
}
#main {
  margin-top: 1em;
  margin-bottom: 4em;
}
#home-jumbotron {
  background-color: inherit;
}
#footer .container {
  padding: 1em 0;
}
#footer a {
  color: inherit;
  text-decoration: underline;
}
.font-125 {
  font-size: 125%;
}
.tag-btn {
  margin-bottom: 0.3em;
}
pre {
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 16px;
}
pre code {
  padding: 0;
  font-size: inherit;
  color: inherit;
  background-color: transparent;
  border-radius: 0;
}
code {
  padding: 2px 4px;
  font-size: 90%;
  color: #c7254e;
  background-color: #f9f2f4;
  border-radius: 4px;
}
img,
iframe,
embed,
video,
audio {
  max-width: 100%;
}
.card-img,
.card-img-top,
.card-img-bottom {
  width: initial;
}
</style>

</head>

  <body class="d-flex flex-column h-100">
    <div id="nav-border" class="container">
  <nav class="navbar navbar-expand-lg navbar-light justify-content-center">
    
    
    <ul class="navbar-nav">
      
        
        
        
        
        
        

        
          <li class="nav-item ">
            <a class="nav-link" href="/">
              
                
                <i data-feather="home"></i> 
              
              Home
            </a>
          </li>
        
      
        
        
        
        
        
        

        
          <li class="nav-item active">
            <a class="nav-link" href="/post/">
              
                
                <i data-feather="file-text"></i> 
              
              Blog
            </a>
          </li>
        
      
        
        
        
        
        
        

        
          <li class="nav-item ">
            <a class="nav-link" href="/learn/">
              
                
                <i data-feather="book-open"></i> 
              
              Learn
            </a>
          </li>
        
      
        
        
        
        
        
        

        
          <li class="nav-item ">
            <a class="nav-link" href="/cuda/">
              
              NVIDIA CUDA
            </a>
          </li>
        
      
        
        
        
        
        
        

        
          <li class="nav-item ">
            <a class="nav-link" href="/rocm/">
              
              AMD ROCm
            </a>
          </li>
        
      
        
        
        
        
        
        

        
          <li class="nav-item ">
            <a class="nav-link" href="/oneapi/">
              
              Intel oneAPI
            </a>
          </li>
        
      
        
        
        
        
        
        

        
          <li class="nav-item ">
            <a class="nav-link" href="/other/">
              
              Other
            </a>
          </li>
        
      
    </ul>
  </nav>
</div>

    <div class="container">
      <main id="main">
        

<h1>CUDA.jl 1.3 - Multi-device programming</h1>



<i data-feather="calendar"></i> <time datetime="2020-07-18">Jul 18, 2020</time>




  <br>
  <i data-feather="edit-2"></i> Tim Besard


<br><br>

    <p>Today we&rsquo;re releasing CUDA.jl 1.3, with several new features. The most prominent
change is support for multiple GPUs within a single process.</p>
<h2 id="multi-gpu-programming">Multi-GPU programming</h2>
<p>With CUDA.jl 1.3, you can finally use multiple CUDA GPUs within a single process. To switch
devices you can call <code>device!</code>, query the current device with <code>device()</code>, or reset it using
<code>device_reset!()</code>:</p>
<pre><code class="language-julia-repl">julia&gt; collect(devices())
9-element Array{CuDevice,1}:
 CuDevice(0): Tesla V100-PCIE-32GB
 CuDevice(1): Tesla V100-PCIE-32GB
 CuDevice(2): Tesla V100-PCIE-32GB
 CuDevice(3): Tesla V100-PCIE-32GB
 CuDevice(4): Tesla V100-PCIE-16GB
 CuDevice(5): Tesla P100-PCIE-16GB
 CuDevice(6): Tesla P100-PCIE-16GB
 CuDevice(7): GeForce GTX 1080 Ti
 CuDevice(8): GeForce GTX 1080 Ti

julia&gt; device!(5)

julia&gt; device()
CuDevice(5): Tesla P100-PCIE-16GB
</code></pre>
<p>Let&rsquo;s define a kernel to show this really works:</p>
<pre><code class="language-julia-repl">julia&gt; function kernel()
           dev = Ref{Cint}()
           CUDA.cudaGetDevice(dev)
           @cuprintln(&quot;Running on device $(dev[])&quot;)
           return
       end

julia&gt; @cuda kernel()
Running on device 5

julia&gt; device!(0)

julia&gt; device()
CuDevice(0): Tesla V100-PCIE-32GB

julia&gt; @cuda kernel()
Running on device 0
</code></pre>
<p>Memory allocations, like <code>CuArray</code>s, are implicitly bound to the device they
were allocated on. That means you should take care to only use an array when the
owning device is active, or you will run into errors:</p>
<pre><code class="language-julia-repl">julia&gt; device()
CuDevice(0): Tesla V100-PCIE-32GB

julia&gt; a = CUDA.rand(1)
1-element CuArray{Float32,1}:
 0.6322775

julia&gt; device!(1)

julia&gt; a
ERROR: CUDA error: an illegal memory access was encountered
</code></pre>
<p>Future improvements might make the array type device-aware.</p>
<h2 id="multitasking-and-multithreading">Multitasking and multithreading</h2>
<p>Dovetailing with the support for multiple GPUs, is the ability to use these GPUs
on separate Julia tasks and threads:</p>
<pre><code class="language-julia-repl">julia&gt; device!(0)

julia&gt; @sync begin
         @async begin
           device!(1)
           println(&quot;Working with $(device()) on $(current_task())&quot;)
           yield()
           println(&quot;Back to device $(device()) on $(current_task())&quot;)
         end
         @async begin
           device!(2)
           println(&quot;Working with $(device()) on $(current_task())&quot;)
         end
       end
Working with CuDevice(1) on Task @0x00007fc9e6a48010
Working with CuDevice(2) on Task @0x00007fc9e6a484f0
Back to device CuDevice(1) on Task @0x00007fc9e6a48010

julia&gt; device()
CuDevice(0): Tesla V100-PCIE-32GB
</code></pre>
<p>Each task has its own local GPU state, such as the device it was bound to,
handles to libraries like CUBLAS or CUDNN (which means that each task can
configure libraries independently), etc.</p>
<h2 id="minor-features">Minor features</h2>
<p>CUDA.jl 1.3 also features some minor changes:</p>
<ul>
<li>Reinstated compatibility with Julia 1.3</li>
<li>Support for CUDA 11.0 Update 1</li>
<li>Support for CUDNN 8.0.2</li>
</ul>
<h2 id="known-issues">Known issues</h2>
<p>Several operations on sparse arrays have been broken since CUDA.jl 1.2, due to
the deprecations that were part of CUDA 11. The next version of CUDA.jl will
drop support for CUDA 10.0 or older, which will make it possible to use new
cuSPARSE APIs and add back missing functionality.</p>



      </main>
    </div>
    
<footer id="footer" class="mt-auto text-center text-muted">
  <div class="container">
    Made with <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/zwbetz-gh/vanilla-bootstrap-hugo-theme">Vanilla</a>
  </div>
</footer>

    <script src="https://juliagpu.org/js/feather.min.js"></script>
<script>
  feather.replace()
</script>


    
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-154489943-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  </body>
</html>
